---
title: "Experimental treatment with edaravone in a mouse model of spinocerebellar ataxia 1"
subtitle: "Analysis of ELISA (brain IL6 and BDNF levels)"
author: "Martina Sucha, Simona Benediktova, Filip Tichanek, Jan Jedlicka, Stepan Kapl, Dana Jelinkova, Zdenka Purkartova, Jan Tuma, Jitka Kuncova, Jan Cendelin"
format: 
  html:
    embed-resources: true
    keep-md: true
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    number-depth: 4
    code-fold: false
    code-summary: "Open code"
editor: visual
project:
  type: default
  output-dir: output
theme: sandstone
fontsize: 13.5px
---

This page shows R code for the study [Sucha et al.](https://www.mdpi.com/1422-0067/24/13/10689) (2023, *International Journal of Molecular Science*).

**Citation**:

> Sucha M, Benediktova S, Tichanek F, Jedlicka J, Kapl S, Jelinkova D, Purkartova Z, Tuma J, Kuncova J, Cendelin J. Experimental Treatment with Edaravone in a Mouse Model of Spinocerebellar Ataxia 1. International Journal of Molecular Sciences. 2023; 24(13):10689. https://doi.org/10.3390/ijms241310689

[GitHub page](https://github.com/filip-tichanek/edaravonSCA1): https://github.com/filip-tichanek/edaravonSCA1

ELISA was used to measure:

- (i) hippocampal levels of interleukin 6 (***IL6***, marker of inflammation)
- (ii) cerebellar level of *IL6*
- (iii) cerebellar level of *Brain-derived neurotrophic factor* (***BDNF***, neuroplasticity-related protein)


# Upload of packages

```{r}
rm(list = ls())

suppressWarnings(suppressMessages( {
library(brms)
library(beeswarm)
library(vioplot)
library(glmmTMB)
library(car)
library(cowplot)
library(ggplot2)
library(tidyverse)
library(bayesplot)
library(gtsummary)
library(vegan)
library(knitr)  
library(ggplot2)  
  } ) )
```

# Data upload and wrangling

```{r}

## Data upload
load("source_data/myEnvironment.RData")
elisa<-read.csv("source_data/elisa_data.csv",stringsAsFactors = T)
summary(elisa)

## Defining new variables
elisa$group<-interaction(elisa$treatment,elisa$genotype)
elisa$group<-factor(elisa$group,levels=c('ctrl.wt','eda.wt','ctrl.sca','eda.sca'))
elisa$sex_num<-ifelse(elisa$sex=="f",-0.5,0.5)

elisa$group_sex<-interaction(elisa$treatment,elisa$genotype,elisa$sex)
elisa$group_sex<-factor(elisa$group_sex, levels=c('ctrl.wt.f','ctrl.wt.m',
                                                 'eda.wt.f','eda.wt.m',
                                                 'ctrl.sca.f','ctrl.sca.m',
                                                 'eda.sca.f','eda.sca.m'))

## subseting datasets
elisa_hp<-subset(elisa,elisa$tissue=='hip')
elisa_cb<-subset(elisa,elisa$tissue=='crbl')
elisa_bdnf <- subset(elisa,elisa$bdnf != 'NA')
```


# Hippocampal IL6

## Data exploration

```{r, fig.height=8, fig.width=4}
par(mar=c(5,3.5,1,1))
par(mgp=c(1.9,0.7,0))
par(mfrow=c(3,1))


plot(elisa_hp$il6~elisa_hp$group,las=2,xlab="",
     col=cola) 

plot(elisa_hp$il6~elisa_hp$group_sex,las=2,xlab="",
     col=cola[c(1,1,2,2,3,3,4,4)]) 

hist(elisa_hp$il6, 12)
```
There is no consistent sex-related difference. Groups with larger value show larger spread and the distribution seems right-tailed. Thus gamma model seems as natural choice. It will be used along Gaussian models and they will be compared with *posterior predictive check* (PPC)


## Modelling

### Setting priors

Summary statistics and other information used for prior specification
```{r}

elisa_hp$group<-relevel(elisa_hp$group,ref='ctrl.sca')

## prior for gamma models
log(mean(elisa_hp$il6))
sd(log(elisa_hp$il6))*5

## prior for Gaussian model
mean(elisa_hp$il6)
sd(elisa_hp[elisa_hp$genotype=="sca",]$il6) * c(5, 2, 1.2)
sd(elisa_hp[elisa_hp$genotype=="wt",]$il6) * c(5, 2, 1.2)
sd(elisa_hp$il6)* c(5, 2, 1.2)
```
Defining priors
```{r}
## Priors for gamma model
prior01 <- c(set_prior("student_t(3, 3.62, 1.23)", class = "b", coef = "Intercept"),
             set_prior("normal(0,2)", class = "b", coef = "groupctrl.wt"),
             set_prior("normal(0,2)", class = "b", coef = "groupeda.wt"),
             set_prior("normal(0,1.2)"  , class = "b", coef = "groupeda.sca"))

## Priors for Gaussian model
prior02 <- c(set_prior("student_t(3, 37, 45)", class = "b", coef = "Intercept"),
             set_prior("normal(0,22)", class = "b", coef = "groupctrl.wt"),
             set_prior("normal(0,22)", class = "b", coef = "groupeda.wt"),
             set_prior("normal(0,11)"  , class = "b", coef = "groupeda.sca"))
```

### Fitting models and convergence check
```{r}
## gamma model
elisa_hp_model_01 <- run_model( 
                brm(il6 ~0+Intercept+group,
                      data=elisa_hp, prior = prior01,
                      family=Gamma(link="log"),
                      save_pars = save_pars(all = TRUE),
                      iter=8000, warmup=2000,chains=2,cores=1,seed=17,
                      control = list(adapt_delta = 0.99)),
                 'output/brm/elisa_hp_model_01', reuse = TRUE)

## Gaussian model
elisa_hp_model_02 <- run_model(
              brm(il6~0+Intercept+group,
                      data=elisa_hp, prior = prior02,
                      family=gaussian(),
                      save_pars = save_pars(all = TRUE),
                      iter=8000, warmup=2000,chains=2,cores=1,seed=17,
                      control = list(adapt_delta = 0.99)),
                 'output/brm/elisa_hp_model_02', reuse = TRUE)

mcmc_trace(elisa_hp_model_01)
mcmc_trace(elisa_hp_model_02)

summary(elisa_hp_model_01)
summary(elisa_hp_model_02)
```
Convergence of both models is fine

### PPC
```{r, fig.height=6, fig.width=5}
pla<-pp_check(elisa_hp_model_01,type='dens_overlay',ndraws = 50)
plb<-pp_check(elisa_hp_model_02,type='dens_overlay',ndraws = 50) 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_hp_model_01,type='dens_overlay_grouped',ndraws = 50,group='group') 
plb<-pp_check(elisa_hp_model_02,type='dens_overlay_grouped',ndraws = 50,group='group') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_hp_model_01,type='scatter_avg') 
plb<-pp_check(elisa_hp_model_02,type='scatter_avg') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pp_check(elisa_hp_model_01,type='ecdf_overlay',ndraws = 200) 
pp_check(elisa_hp_model_02,type='ecdf_overlay',ndraws = 200) 

pla<-pp_check(elisa_hp_model_01,type='ecdf_overlay_grouped',ndraws = 50,group='group') 
plb<-pp_check(elisa_hp_model_02,type='ecdf_overlay_grouped',ndraws = 50,group='group') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_hp_model_01,type="stat_2d", stat = c("max", "min"),ndraws=200)
plb<-pp_check(elisa_hp_model_02,type="stat_2d", stat = c("max", "min"),ndraws=200)
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_hp_model_01,type="stat_2d", stat = c("mean", "sd"),ndraws=200)
plb<-pp_check(elisa_hp_model_02,type="stat_2d", stat = c("mean", "sd"),ndraws=200)
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

### Are there too influential observations?
par(mfrow=c(1,2))
plot(loo(elisa_hp_model_01));loo(elisa_hp_model_01)
plot(loo(elisa_hp_model_02));loo(elisa_hp_model_02)
```
Both models seem to fit the data relatively well. For simplicity, we will use Gaussian models

### Extraction of posterior samples
```{r}
post_fix<-as.data.frame(elisa_hp_model_02, variable = c("b_Intercept","b_groupctrl.wt",
                                                       "b_groupeda.wt","b_groupeda.sca"))
names(post_fix)[1]<-"sca_ctrl"

post_fix$wt_ctrl<-post_fix$sca_ctrl+post_fix$b_groupctrl.wt
post_fix$wt_eda<-post_fix$sca_ctrl+post_fix$b_groupeda.wt
post_fix$sca_eda<-post_fix$sca_ctrl+post_fix$b_groupeda.sca
post_fix$wt_contrast<-post_fix$wt_eda-post_fix$wt_ctrl
summary(post_fix)

groupquant<-sapply(post_fix[,c(5,6,1,7)],function(p) quantile(p, probs = c(0.025,0.975,0.5)))
groupquant<-(groupquant)
```

## Vizualisation
```{r, fig.height=4.11, fig.width=7.5}

## showing data
 
elisa_hp$group<-factor(elisa_hp$group,levels=c('ctrl.wt','eda.wt','ctrl.sca','eda.sca'))

par(mfrow=c(1,2))
par(mar=c(2,3,0,0))
par(mgp=c(2,0.6,0))
range<-c(0,60);scal<-range[2]-range[1]
xrange<-c(0.5,4.5);xscal=xrange[2]-xrange[1]
plot(NULL,xlim=c(xrange[1],xrange[2]),ylim=c(range[1],range[2]),xlab="",
     ylab="IL6 (pg/mg of proteins)",las=1, axes=FALSE,cex.lab=1)

rect(xrange[1],range[2],xrange[2],range[1],col="grey92",border=NA)
x<-range[1]
repeat{
  lines(c(xrange[1],xrange[2]),c(x,x),col="white",lwd=0.7)
  x=x+10;if(x>range[2]){break}}

x<-1
repeat{
  lines(c(x,x),c(range[1],range[2]),col="white",lwd=0.7)
  x=x+1;if(x>4.5){break}}

vioplot(elisa_hp$il6~elisa_hp$group,col=colb,at=c(1:4),add=T,
        border=cola,axes=FALSE,drawRect=F,lwd=1,wex=0.8)

beeswarm(elisa_hp$il6~elisa_hp$group,col=colc,at=c(1:4),
         add=T,pwpch=(16.5+elisa_hp$sex_num) )

tp<-(groupquant[3,])
xx<-1;wid=0.25
repeat{
  lines(c(xx-wid,xx+wid),c(tp[xx],tp[xx]),lwd=2,col="black");
  lines(c(xx,xx),c(groupquant[1,xx],groupquant[2,xx]),lwd=1.7,col="black")
  xx<-xx+1
  if(xx>4){break}}

tckk=-0.02
axis(2,las=2,cex.axis=1.1,at=seq(range[1],range[2],by=20),
     labels=c(rep("",length(seq(range[1],range[2],by=20)))),pos=xrange[1],tck=tckk)
axis(2,las=2,cex.axis=1.1,at=seq(range[1],range[2],by=20),pos=xrange[1],tck=tckk)

axis(side=1,las=1,cex.axis=1.1,at=c(seq(1,4,by=1)),
     labels=c(rep("",length(seq(1,4,by=1)))),pos=range[1],tck=tckk)
lines(c(xrange[1],xrange[2]),c(range[1],range[1]))
text(c(1:4),c(rep(range[1]-0.046*scal,4)),xpd=T,cex=1.1,col=cola,
     c("Wt","Wt", "SCA1", "SCA1"))
ypo<-c(range[1]-0.1*scal,range[1]-0.1*scal)
text(c(1:4),c(ypo[1],ypo[2],ypo[1],ypo[2]),xpd=T,cex=1.1,col=cola,
     c("0","edv", "0", "edv"))

ypos<-17;xpos=1.4
points(xpos,ypos,pch=16,cex=1.4,col=rgb(0.4,0.4,0.4,alpha=0.6))
text(xpos+0.19*xscal,ypos,"Females",col="grey40",cex=1.2)
points(xpos,ypos-0.08*scal,pch=17,cex=1.4,col=rgb(0.4,0.4,0.4,alpha=0.6))
text(xpos+0.19*xscal,ypos-0.08*scal,"Males",col="grey40",cex=1.2)

## posterior probability distributions for between-groups difference 
par(mar=c(2,0,0,0))
dif<-data.frame(post_fix$wt_contrast,post_fix$b_groupeda.sca,
                post_fix$b_groupctrl.wt)
dif<-(dif)

yla<-"Difference in hippocampal IL6"
tckk=-0.018
ste<-seq(-20,15,by=5)
mons_poste(dif,0)

zpos=seq(0,1,1/3)
xx=1;ind=0.4;xpol<--15
text(xpol,zpos[xx]+zpos[2]*ind,
     "Wt: ed x 0 ",cex=1)
xx=xx+1

text(xpol,zpos[xx]+zpos[2]*ind,
     "SCA1: ed x 0 ",cex=1)
xx=xx+1

text(xpol,zpos[xx]+zpos[2]*ind,
     "0: Wt x SCA1",cex=1)
```

# Cerebellar IL6

## Data exploration

```{r, fig.height=8, fig.width=4}
par(mar=c(5,3.5,1,1))
par(mgp=c(1.9,0.7,0))
par(mfrow=c(3,1))


plot(elisa_cb$il6~elisa_cb$group,las=2,xlab="",
     col=cola) 

plot(elisa_cb$il6~elisa_cb$group_sex,las=2,xlab="",
     col=cola[c(1,1,2,2,3,3,4,4)]) 

hist(elisa_cb$il6, 12)
```
No consistent sex effect. Distribution seems relatively symetrical. We will again fit both gamma and Gaussian models


## Modelling

### Setting priors

Summary statistics and other information used for prior specification
```{r}

elisa_cb$group<-relevel(elisa_cb$group,ref='ctrl.sca')

## prior for gamma models
log(mean(elisa_cb$il6))
sd(log(elisa_cb$il6))*5

## prior for Gaussian model
mean(elisa_cb$il6)
sd(elisa_cb[elisa_cb$genotype=="sca",]$il6) * c(5, 2, 1.2)
sd(elisa_cb[elisa_cb$genotype=="wt",]$il6) * c(5, 2, 1.2)
sd(elisa_cb$il6)* c(5, 2, 1.2)
```
Defining priors
```{r}
## Priors for gamma model
prior01 <- c(set_prior("student_t(3, 3.9, 0.53)", class = "b", coef = "Intercept"),
             set_prior("normal(0, 2)", class = "b", coef = "groupctrl.wt"),
             set_prior("normal(0, 2)", class = "b", coef = "groupeda.wt"),
             set_prior("normal(0, 1.2)"  , class = "b", coef = "groupeda.sca"))

## Priors for Gaussian model
prior02 <- c(set_prior("student_t(3, 50, 26)", class = "b", coef = "Intercept"),
             set_prior("normal(0, 11.6)", class = "b", coef = "groupctrl.wt"),
             set_prior("normal(0, 11.6)", class = "b", coef = "groupeda.wt"),
             set_prior("normal(0, 5.4)"  , class = "b", coef = "groupeda.sca"))
```

### Fitting models and convergence check
```{r}
## gamma model
elisa_cb_model_01 <- run_model( 
                brm(il6 ~0+Intercept+group,
                      data=elisa_cb, prior = prior01,
                      family=Gamma(link="log"),
                      save_pars = save_pars(all = TRUE),
                      iter=8000, warmup=2000,chains=2,cores=1,seed=17,
                      control = list(adapt_delta = 0.99)),
                 'output/brm/elisa_cb_model_01', reuse = TRUE)

## Gaussian model
elisa_cb_model_02 <- run_model(
              brm(il6~0+Intercept+group,
                      data=elisa_cb, prior = prior02,
                      family=gaussian(),
                      save_pars = save_pars(all = TRUE),
                      iter=8000, warmup=2000,chains=2,cores=1,seed=17,
                      control = list(adapt_delta = 0.99)),
                 'output/brm/elisa_cb_model_02', reuse = TRUE)

mcmc_trace(elisa_cb_model_01)
mcmc_trace(elisa_cb_model_02)

summary(elisa_cb_model_01)
summary(elisa_cb_model_02)
```
Convergence of both models is fine, ESSs are sufficient

### PPC
```{r, fig.height=6, fig.width=5}
pla<-pp_check(elisa_cb_model_01,type='dens_overlay',ndraws = 50)
plb<-pp_check(elisa_cb_model_02,type='dens_overlay',ndraws = 50) 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_cb_model_01,type='dens_overlay_grouped',ndraws = 50,group='group') 
plb<-pp_check(elisa_cb_model_02,type='dens_overlay_grouped',ndraws = 50,group='group') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_cb_model_01,type='scatter_avg') 
plb<-pp_check(elisa_cb_model_02,type='scatter_avg') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pp_check(elisa_cb_model_01,type='ecdf_overlay',ndraws = 200) 
pp_check(elisa_cb_model_02,type='ecdf_overlay',ndraws = 200) 

pla<-pp_check(elisa_cb_model_01,type='ecdf_overlay_grouped',ndraws = 50,group='group') 
plb<-pp_check(elisa_cb_model_02,type='ecdf_overlay_grouped',ndraws = 50,group='group') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_cb_model_01,type="stat_2d", stat = c("max", "min"),ndraws=200)
plb<-pp_check(elisa_cb_model_02,type="stat_2d", stat = c("max", "min"),ndraws=200)
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_cb_model_01,type="stat_2d", stat = c("mean", "sd"),ndraws=200)
plb<-pp_check(elisa_cb_model_02,type="stat_2d", stat = c("mean", "sd"),ndraws=200)
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

### Are there too influential observations?
par(mfrow=c(1,2))
plot(loo(elisa_cb_model_01));loo(elisa_cb_model_01)
plot(loo(elisa_cb_model_02));loo(elisa_cb_model_02)
```
Both models seem to fit the data relatively well. One observation is apparently outlier, with overly large impact on estimation. The large influence is seen particularly slightly more strongly in gamma model. Again, we will prefer Gaussian model, although both draw the same conlcusions. 

### Extraction of posterior samples
```{r}
post_fix <- as.data.frame(elisa_cb_model_02, variable = c("b_Intercept","b_groupctrl.wt",
                                                       "b_groupeda.wt","b_groupeda.sca"))
names(post_fix)[1] <- "sca_ctrl"

post_fix$wt_ctrl <- post_fix$sca_ctrl+post_fix$b_groupctrl.wt
post_fix$wt_eda <- post_fix$sca_ctrl+post_fix$b_groupeda.wt
post_fix$sca_eda <- post_fix$sca_ctrl+post_fix$b_groupeda.sca
post_fix$wt_contrast <- post_fix$wt_eda-post_fix$wt_ctrl
summary(post_fix)

groupquant<-sapply(post_fix[,c(5,6,1,7)],function(p) quantile(p, probs = c(0.025,0.975,0.5)))
groupquant<-(groupquant)
```

## Vizualisation
```{r, fig.height=4.11, fig.width=7.5}

## showing data
 
elisa_cb$group<-factor(elisa_cb$group,levels=c('ctrl.wt','eda.wt','ctrl.sca','eda.sca'))

par(mfrow=c(1,2))
par(mar=c(2,3,0,0))
par(mgp=c(2,0.6,0))
range<-c(0,60);scal<-range[2]-range[1]
xrange<-c(0.5,4.5);xscal=xrange[2]-xrange[1]
plot(NULL,xlim=c(xrange[1],xrange[2]),ylim=c(range[1],range[2]),xlab="",
     ylab="IL6 (pg/mg of proteins)",las=1, axes=FALSE,cex.lab=1)

rect(xrange[1],range[2],xrange[2],range[1],col="grey92",border=NA)
x<-range[1]
repeat{
  lines(c(xrange[1],xrange[2]),c(x,x),col="white",lwd=0.7)
  x=x+10;if(x>range[2]){break}}

x<-1
repeat{
  lines(c(x,x),c(range[1],range[2]),col="white",lwd=0.7)
  x=x+1;if(x>4.5){break}}

vioplot(elisa_cb$il6~elisa_cb$group,col=colb,at=c(1:4),add=T,
        border=cola,axes=FALSE,drawRect=F,lwd=1,wex=0.8)

beeswarm(elisa_cb$il6~elisa_cb$group,col=colc,at=c(1:4),
         add=T,pwpch=(16.5+elisa_cb$sex_num) )

tp<-(groupquant[3,])
xx<-1;wid=0.25
repeat{
  lines(c(xx-wid,xx+wid),c(tp[xx],tp[xx]),lwd=2,col="black");
  lines(c(xx,xx),c(groupquant[1,xx],groupquant[2,xx]),lwd=1.7,col="black")
  xx<-xx+1
  if(xx>4){break}}

tckk=-0.02
axis(2,las=2,cex.axis=1.1,at=seq(range[1],range[2],by=20),
     labels=c(rep("",length(seq(range[1],range[2],by=20)))),pos=xrange[1],tck=tckk)
axis(2,las=2,cex.axis=1.1,at=seq(range[1],range[2],by=20),pos=xrange[1],tck=tckk)

axis(side=1,las=1,cex.axis=1.1,at=c(seq(1,4,by=1)),
     labels=c(rep("",length(seq(1,4,by=1)))),pos=range[1],tck=tckk)
lines(c(xrange[1],xrange[2]),c(range[1],range[1]))
text(c(1:4),c(rep(range[1]-0.046*scal,4)),xpd=T,cex=1.1,col=cola,
     c("Wt","Wt", "SCA1", "SCA1"))
ypo<-c(range[1]-0.1*scal,range[1]-0.1*scal)
text(c(1:4),c(ypo[1],ypo[2],ypo[1],ypo[2]),xpd=T,cex=1.1,col=cola,
     c("0","edv", "0", "edv"))

ypos<-17;xpos=1.4
points(xpos,ypos,pch=16,cex=1.4,col=rgb(0.4,0.4,0.4,alpha=0.6))
text(xpos+0.19*xscal,ypos,"Females",col="grey40",cex=1.2)
points(xpos,ypos-0.08*scal,pch=17,cex=1.4,col=rgb(0.4,0.4,0.4,alpha=0.6))
text(xpos+0.19*xscal,ypos-0.08*scal,"Males",col="grey40",cex=1.2)

## posterior probability distributions for between-groups difference 
par(mar=c(2,0,0,0))
dif<-data.frame(post_fix$wt_contrast,post_fix$b_groupeda.sca,
                post_fix$b_groupctrl.wt)
dif<-(dif)

yla<-"Difference in cerebellar IL6"
tckk=-0.018
ste<-seq(-20,15,by=5)
mons_poste(dif,0)

zpos=seq(0,1,1/3)
xx=1;ind=0.4;xpol<--15
text(xpol,zpos[xx]+zpos[2]*ind,
     "Wt: ed x 0 ",cex=1)
xx=xx+1

text(xpol,zpos[xx]+zpos[2]*ind,
     "SCA1: ed x 0 ",cex=1)
xx=xx+1

text(xpol,zpos[xx]+zpos[2]*ind,
     "0: Wt x SCA1",cex=1)
```

# Cerebellar BDNF

## Data exploration

```{r, fig.height=8, fig.width=4}
par(mar=c(5,3.5,1,1))
par(mgp=c(1.9,0.7,0))
par(mfrow=c(3,1))


plot(elisa_bdnf$bdnf~elisa_bdnf$group,las=2,xlab="",
     col=cola) 

plot(elisa_bdnf$bdnf~elisa_bdnf$group_sex,las=2,xlab="",
     col=cola[c(1,1,2,2,3,3,4,4)]) 

hist(elisa_bdnf$bdnf, 12)
```
There is no consistent sex-related difference, although specifically in WT, males show trend of higher BDNF levels. Distribution is symmetrical and spread is not larger in groups with larger values. However, we will be consistent with previous ELISA analyses and will also fit both gamma and Gaussian regression


## Modelling

### Setting priors

Summary statistics and other information used for prior specification
```{r}

elisa_bdnf$group<-relevel(elisa_bdnf$group,ref='ctrl.sca')

## prior for gamma models
log(mean(elisa_bdnf$bdnf))
sd(log(elisa_bdnf$bdnf))*5

## prior for Gaussian model
mean(elisa_bdnf$bdnf)
sd(elisa_bdnf[elisa_bdnf$genotype=="sca",]$bdnf) * c(5, 2, 1.2)
sd(elisa_bdnf[elisa_bdnf$genotype=="wt",]$bdnf) * c(5, 2, 1.2)
sd(elisa_bdnf$bdnf)* c(5, 2, 1.2)
```

Defining priors
```{r}
## Priors for gamma model
prior01 <- c(set_prior("student_t(3, 2.8, 1)", class = "b", coef = "Intercept"),
             set_prior("normal(0, 2)", class = "b", coef = "groupctrl.wt"),
             set_prior("normal(0, 2)", class = "b", coef = "groupeda.wt"),
             set_prior("normal(0, 1.2)"  , class = "b", coef = "groupeda.sca"))

## Priors for Gaussian model
prior02 <- c(set_prior("student_t(3, 16, 16)", class = "b", coef = "Intercept"),
             set_prior("normal(0, 5.5)", class = "b", coef = "groupctrl.wt"),
             set_prior("normal(0, 5.5)", class = "b", coef = "groupeda.wt"),
             set_prior("normal(0, 4.3)"  , class = "b", coef = "groupeda.sca"))
```

### Fitting models and convergence check
```{r}
## gamma model
elisa_bdnf_model_01 <- run_model( 
                brm(bdnf ~0+Intercept+group,
                      data=elisa_bdnf, prior = prior01,
                      family=Gamma(link="log"),
                      save_pars = save_pars(all = TRUE),
                      iter=8000, warmup=2000,chains=2,cores=1,seed=17,
                      control = list(adapt_delta = 0.99)),
                 'output/brm/elisa_bdnf_model_01', reuse = TRUE)

## Gaussian model
elisa_bdnf_model_02 <- run_model(
              brm(bdnf~0+Intercept+group,
                      data=elisa_bdnf, prior = prior02,
                      family=gaussian(),
                      save_pars = save_pars(all = TRUE),
                      iter=8000, warmup=2000,chains=2,cores=1,seed=17,
                      control = list(adapt_delta = 0.99)),
                 'output/brm/elisa_bdnf_model_02', reuse = TRUE)

mcmc_trace(elisa_bdnf_model_01)
mcmc_trace(elisa_bdnf_model_02)

summary(elisa_bdnf_model_01)
summary(elisa_bdnf_model_02)
```
Convergence of both models is fine, ESSs are sufficient

### PPC
```{r, fig.height=6, fig.width=5}
pla<-pp_check(elisa_bdnf_model_01,type='dens_overlay',ndraws = 50)
plb<-pp_check(elisa_bdnf_model_02,type='dens_overlay',ndraws = 50) 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_bdnf_model_01,type='dens_overlay_grouped',ndraws = 50,group='group') 
plb<-pp_check(elisa_bdnf_model_02,type='dens_overlay_grouped',ndraws = 50,group='group') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_bdnf_model_01,type='scatter_avg') 
plb<-pp_check(elisa_bdnf_model_02,type='scatter_avg') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pp_check(elisa_bdnf_model_01,type='ecdf_overlay',ndraws = 200) 
pp_check(elisa_bdnf_model_02,type='ecdf_overlay',ndraws = 200) 

pla<-pp_check(elisa_bdnf_model_01,type='ecdf_overlay_grouped',ndraws = 50,group='group') 
plb<-pp_check(elisa_bdnf_model_02,type='ecdf_overlay_grouped',ndraws = 50,group='group') 
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_bdnf_model_01,type="stat_2d", stat = c("max", "min"),ndraws=200)
plb<-pp_check(elisa_bdnf_model_02,type="stat_2d", stat = c("max", "min"),ndraws=200)
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

pla<-pp_check(elisa_bdnf_model_01,type="stat_2d", stat = c("mean", "sd"),ndraws=200)
plb<-pp_check(elisa_bdnf_model_02,type="stat_2d", stat = c("mean", "sd"),ndraws=200)
plot_grid(pla, plb, labels=c("A", "B"), ncol = 1, nrow = 2)

### Are there too influential observations?
par(mfrow=c(1,2))
plot(loo(elisa_bdnf_model_01));loo(elisa_bdnf_model_01)
plot(loo(elisa_bdnf_model_02));loo(elisa_bdnf_model_02)
```
Both models seem to fit the data relatively well. For simplicity, we will use Gaussian models, both models show the same - no evidence for the edaravone effect

### Extraction of posterior samples
```{r}
post_fix <- as.data.frame(elisa_bdnf_model_02, 
                          variable = c("b_Intercept","b_groupctrl.wt",
                                       "b_groupeda.wt","b_groupeda.sca"))
names(post_fix)[1] <- "sca_ctrl"

post_fix$wt_ctrl <- post_fix$sca_ctrl+post_fix$b_groupctrl.wt
post_fix$wt_eda <- post_fix$sca_ctrl+post_fix$b_groupeda.wt
post_fix$sca_eda <- post_fix$sca_ctrl+post_fix$b_groupeda.sca
post_fix$wt_contrast <- post_fix$wt_eda-post_fix$wt_ctrl
summary(post_fix)

groupquant <- sapply(post_fix[,c(5,6,1,7)],function(p) quantile(p, probs = c(0.025,0.975,0.5)))
```

## Vizualisation
```{r, fig.height=4.11, fig.width=7.5}

## showing data
## Final plot ------------
elisa_bdnf$group<-factor(elisa_bdnf$group,levels=
                           c('ctrl.wt','eda.wt','ctrl.sca','eda.sca'))
summary(elisa)
par(mfrow=c(1,2))
par(mar=c(2,3,0,0))
par(mgp=c(2,0.6,0))
range<-c(0,30);scal<-range[2]-range[1]
xrange<-c(0.5,4.5);xscal=xrange[2]-xrange[1]
plot(NULL,xlim=c(xrange[1],xrange[2]),ylim=c(range[1],range[2]),xlab="",
     ylab="BDNF in cerebellum (pg/mg of proteins)",las=1, axes=FALSE,cex.lab=1)

rect(xrange[1],range[2],xrange[2],range[1],col="grey92",border=NA)
x<-range[1]
repeat{
  lines(c(xrange[1],xrange[2]),c(x,x),col="white",lwd=0.7)
  x=x+5;if(x>range[2]){break}}

x<-1
repeat{
  lines(c(x,x),c(range[1],range[2]),col="white",lwd=0.7)
  x=x+1;if(x>4.5){break}}

vioplot(elisa_bdnf$bdnf~elisa_bdnf$group,col=colb,at=c(1:4),add=T,
        border=cola,axes=FALSE,drawRect=F,lwd=1,wex=0.8)

beeswarm(elisa_bdnf$bdnf~elisa_bdnf$group,col=colc,at=c(1:4),add=T,pwpch=(16.5+elisa_bdnf$sex_num) )

tp<-(groupquant[3,])
xx<-1;wid=0.25
repeat{
  lines(c(xx-wid,xx+wid),c(tp[xx],tp[xx]),lwd=2,col="black");
  lines(c(xx,xx),c(groupquant[1,xx],groupquant[2,xx]),lwd=1.7,col="black")
  xx<-xx+1
  if(xx>4){break}}

tckk=-0.02
axis(2,las=2,cex.axis=1.1,at=seq(range[1],range[2],by=5),
     labels=c(rep("",length(seq(range[1],range[2],by=5)))),pos=xrange[1],tck=tckk)
axis(2,las=2,cex.axis=1.1,at=seq(range[1],range[2],by=5),pos=xrange[1],tck=tckk)

axis(side=1,las=1,cex.axis=1.1,at=c(seq(1,4,by=1)),
     labels=c(rep("",length(seq(1,4,by=1)))),pos=range[1],tck=tckk)
lines(c(xrange[1],xrange[2]),c(range[1],range[1]))
text(c(1:4),c(rep(range[1]-0.046*scal,4)),xpd=T,cex=1.1,col=cola,
     c("Wt","Wt", "SCA1", "SCA1"))
ypo<-c(range[1]-0.1*scal,range[1]-0.1*scal)
text(c(1:4),c(ypo[1],ypo[2],ypo[1],ypo[2]),xpd=T,cex=1.1,col=cola,
     c("0","edv", "0", "edv"))

ypos<-27;xpos=1
points(xpos,ypos,pch=16,cex=1.4,col=rgb(0.4,0.4,0.4,alpha=0.6))
text(xpos+0.23*xscal,ypos,"Females",col="grey40",cex=1.2)
points(xpos,ypos-0.08*scal,pch=17,cex=1.4,col=rgb(0.4,0.4,0.4,alpha=0.6))
text(xpos+0.23*xscal,ypos-0.08*scal,"Males",col="grey40",cex=1.2)


## posterior probability distributions for between-groups difference

par(mar=c(2,0,0,0))
dif<-data.frame(post_fix$wt_contrast,post_fix$b_groupeda.sca,
                post_fix$b_groupctrl.wt)
dif<-(dif)

yla<-"Difference in cerebellar bdnf"
tckk=-0.018
ste<-seq(-10,10,by=2)
mons_poste(dif,0)

zpos=seq(0,1,1/3)
xx=1;ind=0.4;xpol<- -6
text(xpol,zpos[xx]+zpos[2]*ind,
     "Wt: ed x 0 ",cex=1)
xx=xx+1

text(xpol,zpos[xx]+zpos[2]*ind,
     "SCA1: ed x 0 ",cex=1)
xx=xx+1

text(xpol,zpos[xx]+zpos[2]*ind,
     "0: Wt x SCA1",cex=1)
```


















